<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pataka Pal</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Find and share food in your neighbourhood through community patakas">
    <meta name="theme-color" content="#289DA7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pataka Pal">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Pataka Pal">
    <meta name="msapplication-TileColor" content="#289DA7">
    <meta name="msapplication-config" content="none">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/webp" href="https://onthehouse.org.nz/wp-content/uploads/2024/07/mini-logo.webp">
    <link rel="apple-touch-icon" href="https://onthehouse.org.nz/wp-content/uploads/2024/07/mini-logo.webp">
    
    <!-- Leaflet Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin=""/>
    
    <!-- External JavaScript Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    
    <!-- Application Styles -->
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>ü•´ Pataka Pal</h1>
            <p>Find and share food in your neighbourhood</p>
        </div>

        <div class="search-container" id="searchContainer">
            <input type="text" class="search-input" placeholder="üîç Search patakas, locations, or food items..." id="searchInput">
        </div>

        <div class="view-toggle" id="viewToggle">
            <button class="toggle-btn active" id="mapBtn">üó∫Ô∏è Map View</button>
            <button class="toggle-btn" id="listBtn">üìã List View</button>
        </div>

        <div class="content">
            <!-- Map View -->
            <div id="mapView" class="map-view">
                <div id="azureMap"></div>
                <div id="mapLoading" class="map-loading hidden">
                    <div>Loading map...</div>
                    <div style="margin-top: 10px; font-size: 0.8rem; color: #666;">This may take up to 60 seconds on first load</div>
                </div>
            </div>

            <!-- List View -->
            <div id="listView" class="cupboard-list hidden">
                <div class="loading" id="loading">Loading patakas...</div>
                <div id="loadingInfo" class="hidden" style="text-align: center; color: #666; padding: 20px; font-size: 0.9rem;">
                    First load may take up to 60 seconds due to Azure cold start...
                </div>
            </div>

            <!-- Donate View -->
            <div id="donateView" class="action-view hidden">
                <div class="step-indicator">
                    <div class="step active" id="donateStep1">1</div>
                    <div class="step" id="donateStep2">2</div>
                    <div class="step" id="donateStep3">3</div>
                    <div class="step" id="donateStep4">4</div>
                </div>

                <div class="action-section active" id="donateSection1">
                    <h2 class="section-title">üì± Scan Pataka QR Code</h2>
                    <p class="section-subtitle">Scan the QR code on the pataka you want to donate to</p>
                    
                    <div class="qr-scanner-container">
                        <video id="donate-qr-scanner"></video>
                        <div class="scanner-overlay"></div>
                        <div class="scanner-message">Point camera at QR code</div>
                    </div>
                    
                    <button class="btn btn-secondary" id="donateUnableToScanBtn">Unable to scan QR code?</button>
                    <button class="btn btn-secondary" id="cancelDonateBtn">Cancel</button>
                </div>

                <div class="action-section" id="donateSection1b">
                    <h2 class="section-title">üìç Select Pataka</h2>
                    <p class="section-subtitle">Choose the pataka you want to donate to</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="donatePatakaSelect">Select Pataka:</label>
                        <select class="form-select" id="donatePatakaSelect">
                            <option value="">Choose a pataka...</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" id="confirmDonatePatakaBtn" disabled>Continue</button>
                    <button class="btn btn-secondary" id="backToDonateQRBtn">Back to QR Scan</button>
                </div>

                <div class="action-section" id="donateSection2">
                    <h2 class="section-title">üì∑ Photo of Food to Donate</h2>
                    <div style="background: #e8f5e9; border: 1px solid #289DA7; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                        <p style="margin: 0; color: #2e7d32; font-weight: 500;">
                            ‚úÖ Donating to <span id="donateSelectedPatakaName" style="font-weight: 600;"></span>
                        </p>
                    </div>
                    <p class="section-subtitle">Take a photo of the food before putting it in the pataka (optional)</p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="btn btn-secondary" id="donateTakePhotoBtn" style="flex: 1; margin-bottom: 0;">üì∑ Take Photo</button>
                        <button type="button" class="btn btn-secondary" id="donateSelectPhotoBtn" style="flex: 1; margin-bottom: 0;">üñºÔ∏è Select from Gallery</button>
                    </div>
                    
                    <div id="donatePhotoPreviewContainer" class="hidden" style="text-align: center; margin: 20px 0;">
                        <img id="donatePhotoPreview" class="photo-preview" alt="Photo preview">
                        <p style="margin-top: 10px; font-size: 0.8rem; color: #666;">Photo added - AI will analyze this</p>
                    </div>
                    
                    <input type="file" id="donateTakePhotoInput" accept="image/*" capture="environment" style="display: none;">
                    <input type="file" id="donateSelectPhotoInput" accept="image/*" style="display: none;">
                    
                    <button class="btn btn-primary" id="donatePhotoNextBtn">Continue</button>
                    <button class="btn btn-secondary" id="donatePhotoBackBtn">Back</button>
                </div>

                <div class="action-section" id="donateSection3">
                    <h2 class="section-title">ü§ñ AI Food Recognition</h2>
                    <p class="section-subtitle">Review and adjust what AI detected (optional)</p>
                    
                    <div id="donateAILoading" class="loading">
                        Analyzing your photo with AI...
                    </div>
                    
                    <div id="donateAIResults" class="ai-results hidden">
                        <h4>ü§ñ AI detected these items:</h4>
                        <div id="donateDetectedItems" class="detected-items"></div>
                        
                        <div class="add-item-section">
                            <h5>Add items manually:</h5>
                            <div class="add-item-form">
                                <input type="text" placeholder="Item name" id="donateManualItemName">
                                <input type="number" placeholder="Qty" id="donateManualItemQty" min="1" value="1" style="width: 60px;">
                                <button type="button" id="donateAddManualBtn">Add</button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="donateAINextBtn">Continue</button>
                    <button class="btn btn-secondary" id="donateAIBackBtn">Back</button>
                </div>

                <div class="action-section" id="donateSection4">
                    <h2 class="section-title">üí¨ Add a Message</h2>
                    <p class="section-subtitle">Leave a message for the community (optional)</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="donateComment">Your message:</label>
                        <textarea class="form-textarea" id="donateComment" placeholder=""></textarea>
                    </div>
                    
                    <button class="btn btn-primary" id="donateSubmitBtn">üéÅ Complete Donation</button>
                    <button class="btn btn-secondary" id="donateCommentBackBtn">Back</button>
                </div>

                <div class="action-section" id="donateSuccess">
                    <div class="success-message">
                        <h3>üéâ Donation Submitted!</h3>
                        <p>Thank you for sharing with your community</p>
                        <p style="margin-top: 15px; font-size: 0.9rem;">Your donation has been added to the pataka inventory.</p>
                    </div>
                    
                    <button class="btn btn-secondary" id="donateBackToMapBtn">Back to Map</button>
                </div>
            </div>

            <!-- Take View -->
            <div id="takeView" class="action-view hidden">
                <div class="step-indicator">
                    <div class="step active" id="takeStep1">1</div>
                    <div class="step" id="takeStep2">2</div>
                    <div class="step" id="takeStep3">3</div>
                </div>

                <div class="action-section active" id="takeSection1">
                    <h2 class="section-title">üì± Scan Pataka QR Code</h2>
                    <p class="section-subtitle">Scan the QR code on the pataka you want to take from</p>
                    
                    <div class="qr-scanner-container">
                        <video id="take-qr-scanner"></video>
                        <div class="scanner-overlay"></div>
                        <div class="scanner-message">Point camera at QR code</div>
                    </div>
                    
                    <button class="btn btn-secondary" id="takeUnableToScanBtn">Unable to scan QR code?</button>
                    <button class="btn btn-secondary" id="cancelTakeBtn">Cancel</button>
                </div>

                <div class="action-section" id="takeSection1b">
                    <h2 class="section-title">üìç Select Pataka</h2>
                    <p class="section-subtitle">Choose the pataka you want to take from</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="takePatakaSelect">Select Pataka:</label>
                        <select class="form-select" id="takePatakaSelect">
                            <option value="">Choose a pataka...</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" id="confirmTakePatakaBtn" disabled>Continue</button>
                    <button class="btn btn-secondary" id="backToTakeQRBtn">Back to QR Scan</button>
                </div>

                <div class="action-section" id="takeSection2">
                    <h2 class="section-title">üõí Take What You Need</h2>
                    <div style="background: #e8f5e9; border: 1px solid #289DA7; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                        <p style="margin: 0; color: #2e7d32; font-weight: 500;">
                            ‚úÖ Taking from <span id="takeSelectedPatakaName" style="font-weight: 600;"></span>
                        </p>
                    </div>
                    <p class="section-subtitle">Take what you need, then optionally <strong>take a photo of what's left in the pataka</strong></p>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="btn btn-secondary" id="takeTakePhotoBtn" style="flex: 1; margin-bottom: 0;">üì∑ Photo of Remaining Items</button>
                        <button type="button" class="btn btn-secondary" id="takeSelectPhotoBtn" style="flex: 1; margin-bottom: 0;">üñºÔ∏è Select from Gallery</button>
                    </div>
                    
                    <div id="takePhotoPreviewContainer" class="hidden" style="text-align: center; margin: 20px 0;">
                        <img id="takePhotoPreview" class="photo-preview" alt="Photo preview">
                        <p style="margin-top: 10px; font-size: 0.8rem; color: #666;">Photo added - AI will analyze remaining items</p>
                    </div>
                    
                    <input type="file" id="takeTakePhotoInput" accept="image/*" capture="environment" style="display: none;">
                    <input type="file" id="takeSelectPhotoInput" accept="image/*" style="display: none;">
                    
                    <button class="btn btn-primary" id="takePhotoNextBtn">Continue</button>
                    <button class="btn btn-secondary" id="takePhotoBackBtn">Back</button>
                </div>

                <div class="action-section" id="takeSection3">
                    <h2 class="section-title">üí¨ Message</h2>
                    <p class="section-subtitle">Leave a message (optional)</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="takeComment">Your message:</label>
                        <textarea class="form-textarea" id="takeComment" placeholder=""></textarea>
                    </div>
                    
                    <button class="btn btn-primary" id="takeSubmitBtn">Submit</button>
                    <button class="btn btn-secondary" id="takeCommentBackBtn">Back</button>
                </div>

                <div class="action-section" id="takeSuccess">
                    <div class="success-message">
                        <h3>Thank you for using Pataka Pal</h3>
                    </div>
                    
                    <button class="btn btn-secondary" id="takeBackToMapBtn">Back to Map</button>
                </div>
            </div>

            <!-- Report View -->
            <div id="reportView" class="action-view hidden">
                <div class="step-indicator">
                    <div class="step active" id="step1">1</div>
                    <div class="step" id="step2">2</div>
                    <div class="step" id="step3">3</div>
                </div>

                <div class="action-section active" id="reportStep1">
                    <h2 class="section-title">üì± Scan Pataka QR Code</h2>
                    <p class="section-subtitle">Please scan the QR code on the pataka you want to report an issue with</p>
                    
                    <div class="qr-scanner-container">
                        <video id="qr-scanner"></video>
                        <div class="scanner-overlay"></div>
                        <div class="scanner-message">Point camera at QR code</div>
                    </div>
                    
                    <button class="btn btn-secondary" id="unableToScanBtn">Unable to scan QR code?</button>
                    <button class="btn btn-secondary" id="cancelReportBtn">Cancel</button>
                </div>

                <div class="action-section" id="reportStep1b">
                    <h2 class="section-title">üìç Select Pataka</h2>
                    <p class="section-subtitle">Choose the pataka you want to report an issue with</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="patakaSelect">Select Pataka:</label>
                        <select class="form-select" id="patakaSelect">
                            <option value="">Choose a pataka...</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-primary" id="confirmPatakaBtn" disabled>Continue</button>
                    <button class="btn btn-secondary" id="backToScanBtn">Back to QR Scan</button>
                </div>

                <div class="action-section" id="reportStep2">
                    <h2 class="section-title">üìù Report Issue</h2>
                    <div style="background: #e8f5e9; border: 1px solid #289DA7; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
                        <p style="margin: 0; color: #2e7d32; font-weight: 500;">
                            ‚úÖ You are reporting an issue with <span id="selectedPatakaName" style="font-weight: 600;"></span>
                        </p>
                    </div>
                    <p class="section-subtitle">Describe the issue and/or take a photo (at least one is required)</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="issueDescription">What's the issue? (Optional)</label>
                        <textarea class="form-textarea" id="issueDescription" placeholder="e.g., Pataka is damaged, needs cleaning, food has spoiled..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Add Photo (Optional)</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="btn btn-secondary" id="takePhotoBtn" style="flex: 1; margin-bottom: 0;">üì∑ Take Photo</button>
                            <button type="button" class="btn btn-secondary" id="selectPhotoBtn" style="flex: 1; margin-bottom: 0;">üñºÔ∏è Select from Gallery</button>
                        </div>
                        <div id="photoPreviewContainer" class="hidden" style="text-align: center; margin-top: 15px;">
                            <img id="photoPreview" class="photo-preview" alt="Photo preview">
                            <p style="margin-top: 10px; font-size: 0.8rem; color: #666;">Photo added successfully</p>
                        </div>
                        <input type="file" id="takePhotoInput" accept="image/*" capture="environment" style="display: none;">
                        <input type="file" id="selectPhotoInput" accept="image/*" style="display: none;">
                    </div>
                    
                    <div class="validation-message hidden" id="reportValidation">Please provide either a description or photo</div>
                    
                    <button class="btn btn-primary" id="continueToContactBtn">Next</button>
                    <button class="btn btn-secondary" id="backToSelectionBtn">Back</button>
                </div>

                <div class="action-section" id="reportStep3">
                    <h2 class="section-title">üë§ Contact Information</h2>
                    <p class="section-subtitle">Please leave your name and contact information if you would like to know the follow-up or if it's ok to contact you for more details (Optional)</p>
                    
                    <div class="form-group">
                        <label class="form-label" for="contactName">Your Name (Optional)</label>
                        <input type="text" class="form-input" id="contactName" placeholder="Enter your name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="contactInfo">Contact Information (Optional)</label>
                        <textarea class="form-textarea" id="contactInfo" placeholder="Phone number, email, or other contact details..."></textarea>
                    </div>
                    
                    <button class="btn btn-primary" id="submitReportBtn">Submit Report</button>
                    <button class="btn btn-secondary" id="backToDetailsBtn">Back</button>
                </div>

                <div class="action-section" id="reportSuccess">
                    <div class="success-message">
                        <h3>‚úÖ Report Submitted!</h3>
                        <p>Your submission has been forwarded to the Kaitiaki</p>
                        <p style="margin-top: 15px; font-size: 0.9rem;">They will review and address the issue as soon as possible.</p>
                    </div>
                    
                    <button class="btn btn-secondary" id="backToMapBtn">Back to Map</button>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" id="findTab">
                <span class="nav-icon">üîç</span>
                <span class="nav-label">Find</span>
            </div>
            <div class="nav-item" id="donateTab">
                <span class="nav-icon">üì∑</span>
                <span class="nav-label">Donate</span>
            </div>
            <div class="nav-item" id="takeTab">
                <span class="nav-icon">üõí</span>
                <span class="nav-label">Take</span>
            </div>
            <div class="nav-item" id="reportTab">
                <span class="nav-icon">‚ö†Ô∏è</span>
                <span class="nav-label">Report</span>
            </div>
        </div>

        <!-- Custom Modal -->
        <div id="customModal" class="modal-overlay hidden">
            <div class="modal">
                <h3 id="modalTitle">Feature Coming Soon</h3>
                <p id="modalMessage">This feature is currently under development.</p>
                <button class="modal-btn" id="modalCloseBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Application JavaScript -->
<script type="module" src="js/config.js"></script>
<script type="module" src="js/app-core.js"></script>
<script type="module" src="js/qr-scanner.js"></script>
<script type="module" src="js/map-functions.js"></script>
<script type="module" src="js/photo-utils.js"></script>
<script type="module" src="js/donate-workflow.js"></script>
<script type="module" src="js/take-workflow.js"></script>
<script type="module" src="js/report-workflow.js"></script>
</body>
</html>